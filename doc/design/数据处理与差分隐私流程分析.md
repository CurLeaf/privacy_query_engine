# 数据处理与差分隐私流程分析

本文件详细解析了从查询初始化到最终输出噪声化结果的完整数据处理流程，该流程结合了SQL重写、敏感度分析和差分隐私技术。

---

## 流程总览

整个流程可分为三个主要阶段：
1.  **初始化阶段**：创建查询驱动器和上下文。
2.  **预处理与分析阶段**：对SQL进行重写并分析其敏感度。
3.  **执行与后处理阶段**：执行原始查询，添加噪声，并进行后处理以生成最终的噪声化结果。

---

## 详细步骤分解

### 阶段一：初始化 (Initialization)

- **`create QueryDriver`**
  - 创建一个用于驱动后续查询执行的核心组件。
  - 这是整个流程的起点，为后续操作提供基础环境。

- **`Init Context`**
  - 初始化查询执行所需的上下文环境。
  - 此步骤通常包括加载配置、建立数据库连接或准备数据源。

---

### 阶段二：预处理与敏感度分析 (Preprocessing & Sensitivity Analysis)

此阶段在实际查询执行前，对SQL语句进行静态分析和转换，以支持差分隐私。

- **`aggregate func rewrite`**
  - 对SQL语句中的聚合函数（如 `SUM`, `COUNT`, `AVG` 等）进行重写。
  - 目的：将复杂的聚合逻辑转化为更易于分析和应用差分隐私的形式。

- **`sql AST` (返回)**
  - 重写完成后，返回对应的抽象语法树（AST），供下一步使用。

- **`clipping rewrite`**
  - 对SQL语句进行“剪裁”重写。这通常涉及对输入数据或中间结果设置边界，以限制单个记录对最终结果的影响（即控制敏感度）。

- **`sql AST` (返回)**
  - 返回经过剪裁重写后的AST。

- **`analysis sensitivity`**
  - 基于重写后的AST，分析查询的敏感度（Sensitivity）。
  - 敏感度是差分隐私中的核心概念，它衡量的是当输入数据集发生微小变化时，查询结果的最大可能变化量。
  - 此分析是计算所需噪声量的关键依据。

- **`sensitivity values` (返回)**
  - 返回计算出的敏感度值，这些值将被用于后续的噪声添加步骤。

---

### 阶段三：执行与后处理 (Execution & Post-processing)

此阶段执行实际的数据查询，并应用差分隐私机制。

- **`execute`**
  - 执行经过预处理的SQL查询，获取原始结果。
  - **`original result` (返回)**: 获取未加噪的原始查询结果。

- **`add noise`**
  - 根据第二阶段计算出的 `sensitivity values`，向 `original result` 添加适当规模的噪声。
  - 常用的噪声机制包括拉普拉斯机制（Laplace Mechanism）或高斯机制（Gaussian Mechanism）。
  - 此步骤确保了结果满足差分隐私的数学定义。

- **`post process`**
  - 对添加噪声后的结果进行后处理。
  - 后处理可能包括：结果格式化、舍入、过滤无效值、或应用其他业务逻辑，以确保输出结果既符合隐私要求，又具有可用性。

- **`noised result` (返回)**
  - 返回经过后处理的最终噪声化结果。

- **最终输出**
  - 将最终的 `noised result` 作为整个流程的输出返回给调用者。

---

## 流程图示意

```plaintext
+------------------+     +------------------+     +------------------+
|   Initialization |     | Preprocessing &  |     | Execution &      |
|                  |     | Sensitivity      |     | Post-processing  |
|  create          |     |  analysis        |     |                  |
|  QueryDriver     |---->|  aggregate func  |---->|  execute         |
|  Init Context    |     |  rewrite         |     |  add noise       |
+------------------+     |  clipping rewrite|     |  post process    |
                         |  analysis         |     +------------------+
                         |  sensitivity      |              |
                         +------------------+              V
                                                        noised result