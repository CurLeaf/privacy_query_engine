# 差分隐私与去标识化查询引擎  
## 并行开发路线图（MVP v1.0–v3.0）

> **文档日期**：2025年12月4日  
> **目标**：构建一个可拦截用户 SQL 查询、自动应用差分隐私（DP）或去标识化（DeID）处理的最小可行系统（MVP）  
> **核心原则**：模块解耦、并行开发、快速集成、安全优先  

---

## 📌 修订说明

根据可行性分析，**系统输出应为"隐私保护后的查询结果"，而非"改写后的 SQL"**。因此，架构中新增 `QueryExecutor` 模块，并调整重写逻辑为**结果级处理**，确保差分隐私在可信服务端完成。

---

## 🧭 总体策略：按能力域并行开发

我们将系统拆解为 **5 个相对独立的能力域（Domains）**，每个域由小型团队或个人负责，在 v1.0–v3.0 范围内可**并行推进**，仅在明确定义的接口处集成。

| 能力域 | 核心目标 | 可并行性 | 关键产出 |
|--------|--------|--------|--------|
| **1. 查询解析与分析** | 理解用户 SQL 语义 | ✅ 高 | `SQLAnalyzer` 模块 |
| **2. 隐私重写与执行逻辑** | 安全应用 DP / DeID 并返回结果 | ✅ 高 | `DP Rewriter` + `DeID Rewriter` + `QueryExecutor` |
| **3. 策略与配置管理** | 支持规则驱动决策 | ⚠️ 中（依赖分析结构） | `PolicyEngine` + `policy.yaml` |
| **4. 查询执行与结果封装** | 执行查询并统一响应格式 | ✅ 高 | `MockDatabaseExecutor` + 响应模型 |
| **5. API 与服务暴露** | 提供 HTTP 接口 | ✅ 高 | `HttpService` |

---

## 🧱 并行实现方向与详细步骤

### 🔹 能力域 1：查询解析与分析（SQL Analysis Domain）

**负责人**：后端/数据工程师  
**目标**：从原始 SQL 中提取聚合函数、字段、表名等元信息。

#### ✅ 可立即开工任务：
1. 选型并集成 SQL 解析库（推荐 Python `sqlparse` 或 Java `JSqlParser`）。
2. 定义 `AnalysisResult` 数据结构：
   ```python
   class AnalysisResult:
       tables: List[str]
       select_columns: List[str]
       aggregations: List[str]  # e.g., ["COUNT", "SUM"]
       has_where: bool
   ```
3. 实现基础解析器，支持以下 SQL 模式：
   - `SELECT COUNT(*) FROM users`
   - `SELECT name, email FROM users WHERE age > 30`
4. 编写单元测试覆盖正例与典型反例。

#### 📅 里程碑：
- **Week 1**：完成基础解析器 + 单元测试
- **Week 2**：支持简单 WHERE 条件、字段别名、多表（仅识别）

---

### 🔹 能力域 2：隐私重写与执行逻辑（Privacy Logic Domain）

**负责人**：隐私算法工程师 + 后端工程师  
**目标**：根据分析结果，安全地应用 DP 或 DeID 并返回结果（**非 SQL**）。

#### ✅ 可立即开工任务：

##### A. 差分隐私路径（DP Track）
1. 实现 `LaplaceMechanism` 类：
   ```python
   def add_laplace_noise(value, epsilon, sensitivity=1.0):
       scale = sensitivity / epsilon
       return value + np.random.laplace(0, scale)
   ```
2. Mock 数据库执行器（返回固定值，如 `count=1000`）。
3. 实现 `apply_dp(result, epsilon=1.0)` → 返回加噪数值。

##### B. 去标识化路径（DeID Track）
1. 实现脱敏函数：
   - `hash_value(val)` → `sha256(val.encode()).hexdigest()[:16]`
   - `mask_email(email)` → `f"{email[0]}***@{email.split('@')[1]}"`
2. 实现字段级脱敏逻辑：若字段名在敏感列表（`name`, `email`），则替换为脱敏值。
3. Mock 执行器返回脱敏后的模拟结果列表。

> ⚠️ **关键原则**：所有隐私操作必须在服务端完成，**禁止在 SQL 中内联噪声函数**。

#### 📅 里程碑：
- **Week 1**：完成 DP 噪声模块 + DeID 脱敏函数
- **Week 2**：集成 mock 执行器，端到端返回保护结果

---

### 🔹 能力域 3：策略与配置管理（Policy Domain）

**负责人**：平台工程师 / DevOps  
**目标**：通过配置驱动 DP/DeID 决策。

#### ✅ 可立即开工任务：
1. 定义策略 YAML 结构（`policy.yaml`）：
   ```yaml
   rules:
     - condition: "aggregations and ('COUNT' in aggregations or 'SUM' in aggregations)"
       action: "DP"
       params: {epsilon: 1.0}
     - condition: "select_columns and any(col in ['name','email'] for col in select_columns)"
       action: "DeID"
       params: {method: "HASH"}
   ```
2. 实现 `ConfigManager` 加载 YAML 配置。
3. 实现 `PolicyEngine.evaluate(analysis_result, config)`，返回：
   ```python
   {"action": "DP", "params": {"epsilon": 1.0}}
   ```
4. 使用安全表达式求值（开发期可用 `asteval`，禁用 `eval`）。

#### 📅 里程碑：
- **Week 2**：完成策略加载 + 规则匹配（依赖域1的 `AnalysisResult` 结构冻结）

---

### 🔹 能力域 4：查询执行与结果封装（Execution Domain）

**负责人**：后端工程师  
**目标**：安全执行查询并统一响应格式。

#### ✅ 可立即开工任务：
1. 实现 `MockDatabaseExecutor`（返回预设数据）。
2. 设计统一响应格式：
   ```json
   {
     "type": "DP" | "DeID",
     "original_query": "SELECT COUNT(*) FROM users;",
     "protected_result": 1023,
     "privacy_info": {
       "epsilon": 1.0,
       "method": "Laplace",
       "sensitivity": 1
     }
   }
   ```
3. 实现 `QueryExecutor` 协调逻辑：
   - 若策略为 DP：执行原 SQL → 加噪 → 返回数值
   - 若策略为 DeID：对结果集中的敏感字段脱敏 → 返回列表

#### 📅 里程碑：
- **Week 1**：完成 mock 执行器 + 响应结构
- **Week 2**：对接真实数据库连接池（可选，v1.0 可用 mock）

---

### 🔹 能力域 5：API 与服务暴露（API Domain）

**负责人**：全栈/后端工程师  
**目标**：提供 HTTP 接口供外部调用。

#### ✅ 可立即开工任务：
1. 选择框架（推荐 FastAPI / Flask / Spring Boot）。
2. 定义 `/api/v1/protect-query` POST 接口：
   - **Request**:
     ```json
     { "sql": "SELECT COUNT(*) FROM users;" }
     ```
   - **Response**:
     ```json
     {
       "status": "success",
       "data": { /* 统一响应格式（见域4） */ }
     }
     ```
3. 集成核心逻辑（初期可 mock `QueryDriver`）。
4. 添加基础错误处理：
   - `400 Bad Request`：SQL 语法错误
   - `422 Unprocessable Entity`：策略未匹配或不支持查询类型

#### 📅 里程碑：
- **Week 1**：完成 API 框架 + mock 响应
- **Week 2**：集成真实 `QueryDriver`

---

## 🔗 集成计划与关键依赖

| 时间 | 集成事件 | 依赖项 | 负责人 |
|------|--------|--------|--------|
| **Week 0** | 接口契约对齐会议 | 确认 `AnalysisResult`、`PolicyRule`、`Response` 结构 | 全体 |
| **End of Week 1** | 各域完成模块骨架 + mock | 无 | 各域负责人 |
| **Week 2 中** | 域1 → 域3：传递分析结果 | `AnalysisResult` 格式冻结 | 域1 & 域3 |
| **Week 2 末** | 全链路集成：<br>API → Driver → Analyzer → Policy → Executor → Response | 所有域接口对齐 | 项目经理 |
| **Week 3** | 端到端测试 + 用户文档 + Demo | 完成 v1.0 可演示版本 | QA + 技术写作 |

---

## 👥 团队组织建议（最小可行团队）

| 角色 | 人数 | 负责能力域 |
|------|------|-----------|
| 后端工程师 | 2 | 域1（解析）、域4（执行）、域5（API） |
| 隐私/算法工程师 | 1 | 域2（DP/DeID 核心逻辑） |
| 平台/DevOps 工程师 | 1 | 域3（策略+配置） |
| **总计** | **4 人** | 可并行开发 v1.0 |

> 💡 **人力优化建议**：若团队 < 4 人，可合并角色（如后端兼做策略引擎，算法工程师协助 API）。

---

## 🚀 交付物与验收标准（v1.0）

| 功能 | 验收标准 |
|------|--------|
| **SQL 解析** | 能正确识别 `COUNT(*)`、`name`、`email` 字段 |
| **DP 处理** | 输入 `SELECT COUNT(*) FROM users` → 返回加噪整数（如 1023） |
| **DeID 处理** | 输入 `SELECT name FROM users` → 返回哈希值列表 |
| **策略决策** | 根据 `policy.yaml` 自动选择 DP 或 DeID |
| **HTTP API** | 成功响应 POST `/api/v1/protect-query` 并返回 JSON |
| **错误处理** | 对不支持的 SQL（如 `JOIN`）返回明确错误 |

---

## 🔜 后续演进提示

- **v2.0**：支持更多聚合函数（SUM、AVG）、敏感字段类型（身份证、手机号）
- **v3.0**：引入隐私预算管理、真实数据库连接、审计日志
- **长期**：支持 SQL 方言（MySQL/PostgreSQL）、性能优化、高可用部署

---

> **项目经理签字**：________________  
> **最后更新**：2025-12-04  
> **文档状态**：Approved for Development

--- 

✅ **本路线图可直接用于 Sprint 规划、任务分配与进度跟踪。**